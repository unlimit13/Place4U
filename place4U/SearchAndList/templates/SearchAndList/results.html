<html lang="ko">
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width,height=device-height, initial-scale=1.0">
        <title>Place4U</title>    
    </head>
    <body>
        <h2> 검색 태그 : {{ tag.searchedTag_text }}</h2>
        <h2> 검색 위치 : {{ tag.location}}</h2>

        <div id="map" style="width:370px;height:600px;"></div>
        <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=8add0bcb02b451c746e38e3443e57e61&libraries=services,clusterer,drawing"></script>

        <script>
            var center_position={
                //latitude : 33.450701,
                //longitude : 126.570667,
                latitude : 37.202561,
                longitude : 127.1052042,
            }; //사용자 입력 위치
            var mapContainer = document.getElementById('map'), // 지도를 표시할 div 
                mapOption = { 
                    center: new kakao.maps.LatLng(center_position.latitude, center_position.longitude), // 지도의 중심좌표
                    level: 5 // 지도의 확대 레벨
                };
            var map = new kakao.maps.Map(mapContainer, mapOption); // 지도를 생성합니다
            

            var list = `{{tag.searchedlist_set.all}}`;
            let positions = [
                {% for list in tag.searchedlist_set.all%}
                    {
                        title: "{{list.Tag}}",
                        content: "{{list.caption}}",
                        list_likes: `{{list.likes}}`,
                        latlng: "{{list.place}}",
                        num: 1 //순서
                    },
                {% endfor %}
            ];

            // 마커를 표시할 위치와 title 객체 
            var geocoder = new kakao.maps.services.Geocoder();
            var positionindex=0;
            for (var i = 0; i < positions.length; i++) {
                geocoder.addressSearch(positions[i].latlng,function(result, status){
                    if(status===kakao.maps.services.Status.OK){
                        coords = new kakao.maps.LatLng(result[0].y,result[0].x);
                        var infowindow = new kakao.maps.InfoWindow({
                            //content : '<div id="info" style="padding:5px;">123</div>',//??
                            content : getcontent(),//??
                            removable : true
                        });
                    }
                    var marker = new kakao.maps.Marker({
                        map: map, // 마커를 표시할 지도
                        position: coords, // 마커를 표시할 위치
                        title : getindex(), // 마커의 타이틀, 마커에 마우스를 올리면 타이틀이 표시됩니다
                        clickable: true
                    });

                    kakao.maps.event.addListener(marker, 'click', makeOverListener(map, marker,infowindow));
                    positionindex++;
                });

                
            }
            function getindex(){
                
                return positionindex;
            }
            function getcontent(){
                return positions[positionindex].list_likes;
            }
            // 인포윈도우를 표시하는 클로저를 만드는 함수입니다
            function makeOverListener(map, marker, infowindow) {
                return function() {
                    infowindow.open(map, marker);
                };
            }
        </script>
        <ol>
            {% for searchedlist in tag.searchedlist_set.all %}
            <li>
                <ul>
                    <li><b>Caption</b> : {{ searchedlist.caption }}</li>
                    <li><b>Likes</b> : {{ searchedlist.likes }}</li>
                    <li><b>Place</b> :  {{ searchedlist.place }}</li>
                </ul>

            </li>
            {% endfor %}
            </li>
        </ol>

    </body>
</html>
