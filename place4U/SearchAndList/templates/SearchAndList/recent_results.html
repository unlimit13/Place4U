<html lang="ko">
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width,height=device-height, initial-scale=1.0">
        <title>Place4U</title>    
    </head>
    <body>
        <h2> 검색 태그 : {{ tag.searchedTag_text }}</h2>
        <h2 id="search_location"> 검색 위치 : </h2>
        <div id="map" style="width:370px;height:400px;"></div>
        <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=8add0bcb02b451c746e38e3443e57e61&libraries=services,clusterer,drawing"></script>

        <script>

            var geocoder = new kakao.maps.services.Geocoder();
            place=[];
            function getinfowindow(){
                
                var infowindow = new kakao.maps.InfoWindow({
                    content : `<p id="info" style="padding:5px;font-size:12px">${place[0]}</p>`,
                    //content : getcontent(),//??
                    removable : true
                });
                place.shift();
                return infowindow
            }
            function pinMarker(map){
                
                var list = `{{tag.searchedlist_set.all}}`;
                let positions = [
                    {% for list in tag.searchedlist_set.all%}
                    //여기에 place거리로 자르는 로직 들어가야함
                        {
                            title: "{{list.Tag}}",
                            content: "{{list.caption}}",
                            list_likes: `{{list.likes}}`,
                            latlng: "{{list.place}}",
                            num: 1 //순서
                        },
                    {% endfor %}
                ];
                for (var i = 0; i < positions.length; i++) {
                    place.push(positions[i].latlng);
                    geocoder.addressSearch(positions[i].latlng,function(result, status){
                        if(status===kakao.maps.services.Status.OK){
                            var coords = new kakao.maps.LatLng(result[0].y,result[0].x);
                            var marker = new kakao.maps.Marker({
                                map: map, // 마커를 표시할 지도
                                position: coords, // 마커를 표시할 위치
                                //title : getindex(), // 마커의 타이틀, 마커에 마우스를 올리면 타이틀이 표시됩니다
                                clickable: true
                            });
        
                            kakao.maps.event.addListener(marker, 'click', makeOverListener(map, marker,getinfowindow()));
         

                        }

                    });
    
                    
                }
            }
            geocoder.addressSearch(`{{tag.searchedLocation_text}}`,function(result, status){
                if(status===kakao.maps.services.Status.OK){
                    var coords = new kakao.maps.LatLng(result[0].y,result[0].x);
                    var mapContainer = document.getElementById('map'), // 지도를 표시할 div 
                    mapOption = { 
                        center: coords, // 지도의 중심좌표
                        level: 7 // 지도의 확대 레벨
                    };
                    var map = new kakao.maps.Map(mapContainer, mapOption); // 지도를 생성합니다
                    var markerImageSrc = 'https://ifh.cc/g/Tzn9L2.png';
                    var imageSize = new kakao.maps.Size(30, 30); 
                    var markerImage = new kakao.maps.MarkerImage(markerImageSrc, imageSize); 
                    var center_marker= new kakao.maps.Marker({
                        map:map,
                        position: coords,
                        image:markerImage
                    })
                    document.getElementById("search_location").innerText="검색 위치 : " +`{{tag.searchedLocation_text}}`;
                    pinMarker(map);
                    
                }


            });

            
            



            // 입력된 list들의 주소->좌표 변경 후 marker 생성
            
            var positionindex=0;

            function getindex(){
                positionindex++;
                return positionindex;
            }
            function getcontent(){
                return positions[positionindex].list_likes;
            }
            // 인포윈도우를 표시하는 클로저를 만드는 함수입니다
            function makeOverListener(map, marker, infowindow) {
                return function() {
                    infowindow.open(map, marker);
                };
            }
        </script>
        <ol>
            {% for searchedlist in tag.searchedlist_set.all %}
            <li>
                <ul>
                    <li><b>Caption</b> : {{ searchedlist.caption }}</li>
                    <li><b>Likes</b> : {{ searchedlist.likes }}</li>
                    <li><b>Place</b> :  {{ searchedlist.place }}</li>
                </ul>

            </li>
            {% endfor %}
            </li>
        </ol>

    </body>
</html>
